name: BuildScanPushDockerImage

on:
  workflow_dispatch:
    inputs:
      DockerFiles:
        description: "Comma-separated list of Dockerfile paths (leave empty to auto-detect all)"
        required: false
        default: ""
      ImageVersion:
        description: "Provide the Image Version to Build"
        required: true
        default: "1.0"

jobs:
  ListAndProcessDockerfiles:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Find Dockerfiles
        id: find_dockerfiles
        run: |
          > dockerfiles.txt
          if [[ -z "${{ github.event.inputs.DockerFiles }}" ]]; then
            dockerfiles=$(find . -name 'Dockerfile')
            echo "Auto-detected Dockerfiles:"
            echo "$dockerfiles"
          else
            dockerfiles=$(echo "${{ github.event.inputs.DockerFiles }}" | tr ',' '\n')
          fi
          echo "$dockerfiles" > dockerfiles.txt
          echo "DOCKERFILES=$dockerfiles" >> $GITHUB_ENV

      - uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Install Trivy via Package Manager
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
          trivy --version

      - name: Process Dockerfiles
        run: |
          failed_images=""
          while IFS= read -r dockerfile; do
            echo "Processing Dockerfile: $dockerfile"
            image_name=$(basename $(dirname $dockerfile))
            image_version="${{ github.event.inputs.ImageVersion }}"
            full_image_name="${{ secrets.ACR_SERVER }}/$image_name:$image_version"

            # Build Docker Image
            echo "Building image: $full_image_name"
            if ! docker build -t "$full_image_name" -f "$dockerfile" .; then
              echo "Failed to build $full_image_name"
              failed_images="$failed_images\n$full_image_name (Build Failed)"
              continue
            fi

            # Trivy Scan
            echo "Scanning image: $full_image_name"
            if ! trivy image --severity HIGH,MEDIUM --exit-code 1 "$full_image_name"; then
              echo "Vulnerability scan failed for $full_image_name"
              failed_images="$failed_images\n$full_image_name (Vulnerabilities Found)"
              continue
            fi

            # Push Docker Image
            echo "Pushing image: $full_image_name"
            if ! docker push "$full_image_name"; then
              echo "Failed to push $full_image_name"
              failed_images="$failed_images\n$full_image_name (Push Failed)"
              continue
            fi
          done < dockerfiles.txt

          # Log and fail the workflow if there are failed images
          if [[ -n "$failed_images" ]]; then
            echo -e "The following images failed to process:\n$failed_images"
            exit 1
          fi
